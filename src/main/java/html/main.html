<!DOCTYPE html>
<html>

<head> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<div>
<video id="localVideo"></video>
</div>
<div>
<video id="remoteVideo"></video>
</div>
<div>
<button onclick="javascript:getRoom()">Get Room</button>
<button onclick="javascript:enterRoom()">Enter Room</button>
<button onclick="localVideo.play()">Show Local</button>
<button onclick="remoteVideo.play()">Show Remote</button>
<input id="roomnumber">
</div>
</body>
<script>

var localVideo;
var localStream;
var serverConnection;
var peerConnection;

window.onload=pageReady;

function getRoom()
{
	serverConnection.send("{\"type\":\"GETROOM\"}");
}

function enterRoom()
{
	serverConnection.send("{\"type\":\"ENTERROOM\",\"value\":"+document.getElementById("roomnumber").value+"}");	
}

function playvideo() {
	  var video = document.getElementById('video');
	  var vendorUrl = window.URL || window.webkitURL;
	  
	  navigator.getMedia = navigator.getUserMedia || 
	  					   navigator.webkitGetUserMedia ||
	  					   navigator.mozGetUserMedia || 
	  					   navigator.msGetUserMedia;
	  
	  // Capture video
	  navigator.getMedia({
		  video: true,
		  audio: false,		  
	  },  function(stream) {
		  video.src = vendorUrl.srcObject = stream;
		  video.play();
	  },  function(error) {
		  // An error occured
		  // error.cod
	  });
 }
 
function pageReady() {
    localVideo = document.getElementById('localVideo');
    remoteVideo = document.getElementById('remoteVideo');

    serverConnection = new WebSocket('ws://127.0.0.1:30001');
    serverConnection.onmessage = gotMessageFromServer;
    
    var constraints = {
        video: true,
        audio: true,
    };

    if(navigator.getUserMedia) {
        navigator.getUserMedia(constraints, getUserMediaSuccess, getUserMediaError);
    } else {
        alert('Your browser does not support getUserMedia API');
    }
}
function getUserMediaSuccess(stream) {
    localStream = stream;
    localVideo.src = window.URL.createObjectURL(stream);
}

function getUserMediaError(error) {
    console.log(error);
}
function start(isCaller) {
    peerConnection = new RTCPeerConnection();
    peerConnection.onicecandidate = gotIceCandidate;
    peerConnection.onaddstream = gotRemoteStream;
    peerConnection.addStream(localStream);

    if(isCaller) {
        peerConnection.createOffer(gotDescription, createOfferError);
    }
}

function gotDescription(description) {
    console.log('got description');
    peerConnection.setLocalDescription(description, function () {
        serverConnection.send(JSON.stringify({'sdp': description}));
    }, function() {console.log('set description error')});
}

function gotIceCandidate(event) {
    if(event.candidate != null) {
        serverConnection.send(JSON.stringify({'ice': event.candidate}));
    }
}

function gotRemoteStream(event) {
    console.log('got remote stream');
    remoteVideo.src = window.URL.createObjectURL(event.stream);
}

function createOfferError(error) {
    console.log(error);
}
function gotMessageFromServer(message) {
	
	console.log(message);
	document.getElementById("roomnumber").value = JSON.parse(message.data).value;

	if(!peerConnection) start(false);

    var signal = JSON.parse(message.data);
    if(signal.sdp) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp), function() {
            if(signal.sdp.type == 'offer') {
                peerConnection.createAnswer(gotDescription, createAnswerError);
            }
        });
    } else if(signal.ice) {
        peerConnection.addIceCandidate(new RTCIceCandidate(signal.ice));
    }
}
function createAnswerError(error) {
	console.log(error);
}
</script>
</html>